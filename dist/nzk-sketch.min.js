!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.nzkSketch=e()}(this,function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function i(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}var a=function(){function e(i,a){t(this,e),this.style=i,this.points=[],a&&this.points.push({s:a,h:null})}return i(e,[{key:"length",value:function(){return this.points.length}},{key:"lastPoint",value:function(){return this.points[this.points.length-1].s}},{key:"addPoint",value:function(t){return this.points[this.points.length-1].h={x:(this.points[this.points.length-1].s.x+t.x)/2,y:(this.points[this.points.length-1].s.y+t.y)/2},this.points.push({s:t,h:null})}},{key:"serialize",value:function(){return{points:this.points,style:this.style}}},{key:"deserialize",value:function(t){this.style=t.style,this.points=t.points||[]}}]),e}(),n=function(){function e(){t(this,e),this.colour=[0,0,0],this.eraser=!1,this.fill=!1,this.opacity=1,this.size=10,this.scale=window.devicePixelRatio>=1.5?2:1,this.actions=[],this.lastActionIndex=-1,this.currentStroke=null}return i(e,[{key:"sizeScaled",value:function(){return this.size*this.scale}},{key:"generateStyleKey",value:function(){return"".concat(this.eraser||1===this.opacity?"opaque":"transparent").concat(this.eraser?"Eraser":"Colour").concat(this.fill?"Fill":"Stroke")}},{key:"getStyle",value:function(){return{opacity:this.opacity,colour:this.colour,eraser:this.eraser,size:this.sizeScaled(),key:this.generateStyleKey()}}},{key:"initStroke",value:function(t){this.canRedo()&&(-1===this.lastActionIndex?this.actions=[]:this.actions=this.actions.slice(0,this.lastActionIndex+1)),this.currentStroke=new a(this.getStyle(),t)}},{key:"continueStroke",value:function(t){this.currentStroke.addPoint(t)}},{key:"saveStroke",value:function(){this.actions.push({type:"stroke",object:this.currentStroke}),this.currentStroke=null,this.lastActionIndex++}},{key:"canUndo",value:function(){return this.lastActionIndex>-1}},{key:"canRedo",value:function(){return this.lastActionIndex<this.actions.length-1}},{key:"reset",value:function(){return this.actions=[],this.lastActionIndex=-1,this.currentStroke=null}},{key:"serialize",value:function(){var t={colour:this.colour,opacity:this.opacity,size:this.size,scale:this.scale,lastActionIndex:this.lastActionIndex,actions:[]};return this.actions.forEach(function(e){"stroke"===e.type&&t.actions.push(e.object.serialize())}),this.currentStroke&&(t.currentStroke=this.currentStroke.serialize()),t}},{key:"deserialize",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.colour&&(this.colour=e.colour),e.opacity&&(this.opacity=e.opacity),e.size&&(this.size=e.size),e.scale&&(this.scale=e.scale),e.lastActionIndex&&(this.lastActionIndex=e.lastActionIndex),e.actions&&(this.actions=[],e.actions.forEach(function(e){if("stroke"===e.type){var i=new a;i.deserialize(e.object),e.stroke=i}t.actions.push(e)})),e.currentStroke&&(this.currentStroke=new a,this.currentStroke.deserialize(e.currentStroke))}}]),e}();return function(){function e(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t(this,e),!i.containerEl)throw new Error("NZKSketch requires a containerEl property");if(!i.width&&i.height)throw new Error("NZKSketch requires fixed width and height properties");this.containerEl=i.containerEl,this.width=i.containerEl.offsetWidth,this.height=i.containerEl.offsetHeight,this.scale=window.devicePixelRatio>=1.5?2:1,this.widthScaled=this.width*this.scale,this.heightScaled=this.height*this.scale,this.orientation=this.width>this.height?"landscape":"portrait",this.template=i.template,this.model=new n,this.setToolType(i.toolType||"brush"),this.setToolColour(i.toolColour||[0,0,0]),this.setToolSize(i.toolSize||15),this.setToolOpacity(i.toolOpacity||1),this.template&&this.initTemplateCanvas(this.template),this.initDrawingCanvas(),this.initBufferCanvas(),this.initCacheCanvas(),this.initInteractionLayer(),this.initDrawAnimations(),this.setDrawingStyle(this.model.getStyle(),this.bufferCanvasCtx),this.isDrawing=!1}return i(e,[{key:"setToolType",value:function(t){switch(t){case"eraser":this.model.eraser=!0,this.model.fill=!1,this.model.opacity=1;break;case"fill":this.model.eraser=!1,this.model.fill=!0;break;default:this.model.eraser=!1,this.model.fill=!1}}},{key:"setToolColour",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0];"eraser"!==this.toolType&&(this.model.colour=t)}},{key:"setToolSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15;this.model.size=t}},{key:"setToolOpacity",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;"eraser"!==this.toolType&&(this.model.opacity=t)}},{key:"export",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.crop=t.crop||!1,t.maxWidth=t.maxWidth||!1,t.maxHeight=t.maxHeight||!1;var e=null;if(this.findBoundingBox(this.drawingCanvasCtx).width<5)return null;this.template?(this.templateCanvasCtx.drawImage(this.drawingCanvasCtx.canvas,0,0,this.widthScaled,this.heightScaled),e=this.templateCanvasCtx):e=this.drawingCanvasCtx;var i={topLeftX:0,topLeftY:0,width:this.widthScaled,height:this.heightScaled};t.crop&&(i=this.findBoundingBox(e));var a,n=1,s=1;t.maxWidth&&i.width>t.maxWidth&&(n=i.width/t.maxWidth),t.maxHeight&&i.height>t.maxHeight&&(s=i.height/t.maxHeight),a=Math.max(n,s),this.initExportCanvas(),this.exportCanvas.setAttribute("width",i.width/a),this.exportCanvas.setAttribute("height",i.height/a),this.exportCanvasCtx.globalCompositeOperation="copy",this.exportCanvasCtx.drawImage(e.canvas,i.topLeftX,i.topLeftY,i.width,i.height,0,0,i.width/a,i.height/a);var o=this.exportCanvas.toDataURL();return this.removeExportCanvas(),o}},{key:"undo",value:function(){if(this.model.canUndo()){this.model.lastActionIndex--,this.drawingCanvasCtx.clearRect(0,0,this.widthScaled,this.heightScaled);for(var t=0;t<=this.model.lastActionIndex;t++)this.drawUndoStroke(this.model.actions[t].object)}}},{key:"redo",value:function(){if(this.model.canRedo()){this.model.lastActionIndex++;var t=this.model.actions[this.model.lastActionIndex];this.drawUndoStroke(t.object)}}},{key:"canUndo",value:function(){return this.model.canUndo()}},{key:"canRedo",value:function(){return this.model.canRedo()}},{key:"restart",value:function(){this.model.reset(),this.drawingCanvasCtx.clearRect(0,0,this.widthScaled,this.heightScaled)}},{key:"setCanvasSize",value:function(t){t.width=this.widthScaled,t.height=this.heightScaled}},{key:"setLayerStyle",value:function(t){t.style.width="".concat(this.width,"px"),t.style.height="".concat(this.height,"px"),t.style.position="absolute",t.style.left="0px",t.style.top="0px"}},{key:"initTemplateCanvas",value:function(t){this.templateCanvas=document.createElement("canvas"),this.templateCanvasCtx=this.templateCanvas.getContext("2d"),this.setCanvasSize(this.templateCanvas),this.setLayerStyle(this.templateCanvas),this.templateCanvasCtx.drawImage(t,0,0,this.widthScaled,this.heightScaled),this.templateCanvas.style.zIndex=0,this.containerEl.appendChild(this.templateCanvas)}},{key:"initDrawingCanvas",value:function(){this.drawingCanvas=document.createElement("canvas"),this.drawingCanvasCtx=this.drawingCanvas.getContext("2d"),this.setCanvasSize(this.drawingCanvas),this.setLayerStyle(this.drawingCanvas),this.drawingCanvas.style.zIndex=1,this.containerEl.appendChild(this.drawingCanvas)}},{key:"initBufferCanvas",value:function(){this.bufferCanvas=document.createElement("canvas"),this.bufferCanvasCtx=this.bufferCanvas.getContext("2d"),this.setCanvasSize(this.bufferCanvas),this.setLayerStyle(this.bufferCanvas),this.bufferCanvas.style.zIndex=2,this.containerEl.appendChild(this.bufferCanvas)}},{key:"initCacheCanvas",value:function(){this.cacheCanvas=document.createElement("canvas"),this.cacheCanvasCtx=this.cacheCanvas.getContext("2d"),this.setCanvasSize(this.cacheCanvas),this.setLayerStyle(this.cacheCanvas),this.cacheCanvas.style.display="none",this.containerEl.appendChild(this.cacheCanvas)}},{key:"initExportCanvas",value:function(){this.exportCanvas=document.createElement("canvas"),this.exportCanvasCtx=this.exportCanvas.getContext("2d"),this.setCanvasSize(this.exportCanvas),this.setLayerStyle(this.exportCanvas),this.exportCanvas.style.display="none",this.containerEl.appendChild(this.exportCanvas)}},{key:"removeExportCanvas",value:function(){this.exportCanvas.remove()}},{key:"initInteractionLayer",value:function(){var t=this;this.interactionLayerEl=document.createElement("div"),this.setLayerStyle(this.interactionLayerEl),this.interactionLayerEl.style.zIndex=3,this.onStartMouseDraw=this.onStartMouseDraw.bind(this),this.onMoveMouseDraw=this.onMoveMouseDraw.bind(this),this.onEndMouseDraw=this.onEndMouseDraw.bind(this),this.interactionLayerEl.addEventListener("mousedown",this.onStartMouseDraw),this.interactionLayerEl.addEventListener("mousemove",this.onMoveMouseDraw),this.interactionLayerEl.addEventListener("mouseup",this.onEndMouseDraw),this.interactionLayerEl.addEventListener("mouseleave",this.onEndMouseDraw),this.interactionLayerEl.addEventListener("mouseenter",function(e){e.buttons>0&&t.onStartMouseDraw(e)},!1),this.onStartTouchDraw=this.onStartTouchDraw.bind(this),this.onMoveTouchDraw=this.onMoveTouchDraw.bind(this),this.onEndTouchDraw=this.onEndTouchDraw.bind(this),this.interactionLayerEl.addEventListener("touchstart",this.onStartTouchDraw),this.interactionLayerEl.addEventListener("touchmove",this.onMoveTouchDraw),this.interactionLayerEl.addEventListener("touchend",this.onEndTouchDraw),this.interactionLayerEl.addEventListener("touchcancel",this.onEndTouchDraw),this.containerEl.appendChild(this.interactionLayerEl)}},{key:"initDrawAnimations",value:function(){this.drawUndo={transparentEraserFill:this.drawTransparentFillFinal,transparentEraserStroke:this.drawStrokeFinal,transparentColourFill:this.drawTransparentFillFinal,transparentColourStroke:this.drawStrokeFinal,opaqueEraserFill:this.drawEraserUndoingFillFinal,opaqueEraserStroke:this.drawEraserUndoingFinal,opaqueColourFill:this.drawFillFinal,opaqueColourStroke:this.drawStrokeFinal},this.drawFinished={transparentEraserFill:this.drawTransparentFillFinal,transparentEraserStroke:this.drawStrokeFinal,transparentColourFill:this.drawTransparentFillFinal,transparentColourStroke:this.drawStrokeFinal,opaqueEraserFill:this.drawEraserFillFinal,opaqueEraserStroke:this.drawEraser,opaqueColourFill:this.drawFillFinal,opaqueColourStroke:this.drawStrokeFinal},this.drawAnimation={transparentEraserFill:this.drawFillAndStroke,transparentEraserStroke:this.drawFillAndStroke,transparentColourFill:this.drawFillAndStroke,transparentColourStroke:this.drawFillAndStroke,opaqueEraserFill:this.drawEraser,opaqueEraserStroke:this.drawEraser,opaqueColourFill:this.drawFillAndStroke,opaqueColourStroke:this.drawFillAndStroke}}},{key:"getMousePoint",value:function(t){var e=this.interactionLayerEl.getBoundingClientRect();return{x:(t.clientX-e.left)*this.scale,y:(t.clientY-e.top)*this.scale}}},{key:"getTouchPoint",value:function(t){var e=this.interactionLayerEl.getBoundingClientRect();return{x:(t.touches[0].clientX-e.left)*this.scale,y:(t.touches[0].clientY-e.top)*this.scale}}},{key:"onStartMouseDraw",value:function(t){t.preventDefault(),this.startDraw(this.getMousePoint(t))}},{key:"onStartTouchDraw",value:function(t){t.preventDefault(),t.stopPropagation(),this.startDraw(this.getTouchPoint(t))}},{key:"onMoveMouseDraw",value:function(t){t.preventDefault(),t.stopPropagation(),this.continueDraw(this.getMousePoint(t))}},{key:"onMoveTouchDraw",value:function(t){t.preventDefault(),t.stopPropagation(),this.continueDraw(this.getTouchPoint(t))}},{key:"onEndMouseDraw",value:function(t){this.endDraw()}},{key:"onEndTouchDraw",value:function(t){this.endDraw()}},{key:"startDraw",value:function(t){this.isDrawing=!0,this.model.initStroke(t),this.model.currentStroke.style.eraser&&1===this.model.currentStroke.style.opacity&&(this.cacheCanvasCtx.globalCompositeOperation="copy",this.cacheCanvasCtx.drawImage(this.drawingCanvasCtx.canvas,0,0,this.widthScaled,this.heightScaled),this.setDrawingStyle(this.model.currentStroke.style,this.drawingCanvasCtx)),this.setDrawingStyle(this.model.currentStroke.style,this.bufferCanvasCtx),this.strokeAnimation()}},{key:"continueDraw",value:function(t){if(!this.isDrawing)return!1;this.model.continueStroke(t)}},{key:"endDraw",value:function(){this.model.currentStroke&&(this.isDrawing=!1,this.endStrokeAnimation(),this.bufferCanvasCtx.clearRect(0,0,this.widthScaled,this.heightScaled),this.drawFinishedStroke(this.model.currentStroke),this.model.saveStroke())}},{key:"setDrawingStyle",value:function(t,e){var i="rgba(".concat(t.colour[0],", ").concat(t.colour[1],", ").concat(t.colour[2],", ").concat(t.opacity,")");e.strokeStyle=i,e.fillStyle=i,e.lineWidth=t.size,e.lineJoin="round",e.lineCap="round"}},{key:"strokeAnimation",value:function(){var t=this;this.drawAnimationStroke(this.model.currentStroke),this.reqStroke=window.requestAnimationFrame(function(){return t.strokeAnimation.apply(t)})}},{key:"drawAnimationStroke",value:function(t){this.drawAnimation[t.style.key].apply(this,[t])}},{key:"endStrokeAnimation",value:function(){window.cancelAnimationFrame(this.reqStroke),this.reqStroke=0}},{key:"drawUndoStroke",value:function(t){this.setDrawingStyle(t.style,this.drawingCanvasCtx),this.drawUndo[t.style.key].apply(this,[t])}},{key:"drawFinishedStroke",value:function(t){t&&(this.setDrawingStyle(t.style,this.drawingCanvasCtx),this.drawFinished[t.style.key].apply(this,[t]))}},{key:"drawExistingStroke",value:function(t){this.setDrawingStyle(t.style,this.drawingCanvasCtx),this.drawFinished[t.style.key].apply(this,[t,!1])}},{key:"trace",value:function(t,e){var i,a,n,s,o=t.length();if(e.beginPath(),o<3)e.moveTo(t.points[0].s.x,t.points[0].s.y),e.lineTo(t.points[o-1].s.x+.001,t.points[o-1].s.y+.001);else for(e.moveTo(t.points[0].s.x,t.points[0].s.y),i=0,a=(s=t.points.slice(1,+(o-2)+1||9e9)).length;i<a;i++)n=s[i],e.quadraticCurveTo(n.s.x,n.s.y,n.h.x,n.h.y)}},{key:"drawTransparentFillFinal",value:function(t){this.cacheCanvasCtx.clearRect(0,0,this.widthScaled,this.heightScaled),this.cacheCanvasCtx.globalCompositeOperation="source-over",t.style.opacity=t.style.opacity||1,this.setDrawingStyle(t.style,this.cacheCanvasCtx),this.trace(t,this.cacheCanvasCtx),this.cacheCanvasCtx.closePath(),this.cacheCanvasCtx.fill(),this.cacheCanvasCtx.stroke(),this.drawingCanvasCtx.globalCompositeOperation="source-over",this.drawingCanvasCtx.globalAlpha=t.style.opacity,this.drawingCanvasCtx.drawImage(this.cacheCanvasCtx.canvas,0,0,this.widthScaled,this.heightScaled),this.drawingCanvasCtx.globalAlpha=1}},{key:"drawStrokeFinal",value:function(t){this.drawingCanvasCtx.globalCompositeOperation="source-over",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.stroke()}},{key:"drawFillFinal",value:function(t){this.drawingCanvasCtx.globalCompositeOperation="source-over",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.closePath(),this.drawingCanvasCtx.fill(),this.drawingCanvasCtx.stroke()}},{key:"drawFillAndStroke",value:function(t){this.bufferCanvasCtx.clearRect(0,0,this.widthScaled,this.heightScaled),this.trace(t,this.bufferCanvasCtx),this.bufferCanvasCtx.stroke()}},{key:"drawEraserUndoingFinal",value:function(t){this.drawingCanvasCtx.globalCompositeOperation="destination-out",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.stroke()}},{key:"drawEraserUndoingFillFinal",value:function(t){this.drawingCanvasCtx.globalCompositeOperation="destination-out",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.closePath(),this.drawingCanvasCtx.fill(),this.drawingCanvasCtx.stroke()}},{key:"drawEraser",value:function(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&(this.drawingCanvasCtx.globalCompositeOperation="copy",this.drawingCanvasCtx.drawImage(this.cacheCanvasCtx.canvas,0,0,this.widthScaled,this.heightScaled)),this.drawingCanvasCtx.globalCompositeOperation="destination-out",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.stroke()}},{key:"drawEraserFillFinal",value:function(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&(this.drawingCanvasCtx.globalCompositeOperation="copy",this.drawingCanvasCtx.drawImage(this.cacheCanvasCtx.canvas,0,0,this.widthScaled,this.heightScaled)),this.drawingCanvasCtx.globalCompositeOperation="destination-out",this.trace(t,this.drawingCanvasCtx),this.drawingCanvasCtx.closePath(),this.drawingCanvasCtx.fill(),this.drawingCanvasCtx.stroke()}},{key:"findBoundingBox",value:function(t){for(var e=t.getImageData(0,0,this.widthScaled,this.heightScaled),i={topLeftX:this.widthScaled,topLeftY:this.heightScaled,bottomRightX:0,bottomRightY:0},a=0;a<this.widthScaled;a++)for(var n=0;n<this.heightScaled;n++){var s=4*(n*this.widthScaled+a)+3;e.data[s]>0&&(a<i.topLeftX&&(i.topLeftX=a),n<i.topLeftY&&(i.topLeftY=n),a>i.bottomRightX&&(i.bottomRightX=a),n>i.bottomRightY&&(i.bottomRightY=n))}return i.width=i.bottomRightX-i.topLeftX,i.height=i.bottomRightY-i.topLeftY,i}}]),e}()});
//# sourceMappingURL=nzk-sketch.min.js.map
